<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>XPDTN Season 4 Survey Results - Live Dashboard</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height:1.6; color:#fff; background:#1a1a1a;
}
.loading { text-align:center; padding:40px; color:#9ca3af; font-size:1.1em; }
.error { background:#3d1a1a; color:#ff6b6b; padding:20px; margin:20px; border-radius:10px; border:1px solid #5a2a2a; }
.container { max-width:100%; margin:0; background:#1a1a1a; padding:0 16px; }
.content { padding:5px 0 15px 0; background:#1a1a1a; max-width:100%; }
.section { margin-bottom:25px; }
.survey-question {
  background:#2a2a2a; border-radius:16px; padding:18px; border:1px solid #3a3a3a;
  box-shadow:0 3px 8px rgba(0,0,0,0.3); animation:slideIn .5s ease-out;
}
@keyframes slideIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
.section-title { font-size:1.3em; margin-bottom:8px; color:#fff; font-weight:600; line-height:1.3; }
.response-count { color:#9ca3af; font-size:.9em; margin-bottom:15px; }
.responses-container { background:#1a1a1a; border-radius:12px; padding:0 0 4px 0; border:1px solid #3a3a3a; }
.response-item {
  display:flex; align-items:center; padding:16px 18px; margin-bottom:4px; border-radius:6px; position:relative; background:#1a1a1a; animation:fadeInBar .8s ease-out;
}
@keyframes fadeInBar { from {opacity:0; transform:translateX(-20px);} to {opacity:1; transform:translateX(0);} }
.response-item:last-child { margin-bottom:0; }
.response-content { flex:1; margin-right:15px; z-index:2; position:relative; }
.response-text { color:#fff; font-weight:600; margin-bottom:0; font-size:1.1em; line-height:1.3; }
.response-bar { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; border-radius:6px; }
.response-bar-fill {
  height:100%; background:linear-gradient(90deg, #625166, #4a3d52);
  transition:width 1.2s ease-in-out; opacity:.8; border-radius:6px; width:0%;
}
.response-stats { text-align:right; flex-shrink:0; min-width:75px; z-index:2; position:relative; }
.response-percentage { color:#625166; font-weight:700; font-size:1.2em; }
.response-number { color:#9ca3af; font-size:.85em; margin-top:1px; }
.other-responses { background:#1a1a1a; border-radius:12px; padding:15px; border:1px solid #3a3a3a; margin-top:12px; }
.other-title { color:#625166; font-weight:600; margin-bottom:6px; font-size:1em; }
.other-text { color:#d1d5db; line-height:1.5; font-size:.9em; white-space:pre-wrap; }
.update-time { text-align:center; color:#6b7280; font-size:.75em; margin-top:15px; margin-bottom:20px; padding:8px; }
@media (max-width:480px) {
  .container { padding:0 12px; }
  .content { padding:3px 0 12px 0; }
  .section-title { font-size:1.2em; }
  .response-text { font-size:1em; }
  .response-percentage { font-size:1.1em; }
  .response-item { padding:14px 16px; }
  .response-content { margin-right:12px; }
  .response-stats { min-width:65px; }
}
</style>
</head>
<body>
  <div id="dashboard-content">
    <div class="loading"><div>Loading survey data...</div></div>
  </div>

<script>
async function fetchSurvey() {
  const r = await fetch('/api/survey-data', { cache: 'no-store' });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

function renderDashboard(data) {
  const questions = Array.isArray(data?.questions) ? data.questions : [];

  if (!questions.length) {
    showError('No survey data to display.', true);
    return;
  }

  let html = `<div class="container"><div class="content">`;

  questions.forEach((q) => {
    const total = q.total_responses || 0;

    html += `
      <div class="section">
        <div class="survey-question">
          <h2 class="section-title">${q.question}</h2>
          <div class="response-count">${total} response${total !== 1 ? 's' : ''}</div>
          <div class="responses-container">
    `;

    (q.responses || []).forEach(res => {
      const pct = Number(res.percentage || 0); // trust API %
      const cnt = Number(res.count || 0);
      html += `
        <div class="response-item">
          <div class="response-bar"><div class="response-bar-fill" style="width:${pct}%"></div></div>
          <div class="response-content"><div class="response-text">${res.text}</div></div>
          <div class="response-stats">
            <div class="response-percentage">${pct}%</div>
            <div class="response-number">${cnt} ${cnt === 1 ? 'response' : 'responses'}</div>
          </div>
        </div>
      `;
    });

    html += `</div>`; // responses-container

    // Verbatim "Other responses" (if provided by API)
    if (q.other_responses && q.other_responses.trim()) {
      html += `
        <div class="other-responses">
          <div class="other-title">Other responses:</div>
          <div class="other-text">${q.other_responses}</div>
        </div>
      `;
    }

    html += `</div></div>`; // survey-question / section
  });

  html += `<div class="update-time">Last updated: ${new Date().toLocaleString()}</div></div></div>`;

  const root = document.getElementById('dashboard-content');
  root.innerHTML = html;

  // Animate bars
  setTimeout(() => {
    document.querySelectorAll('.response-bar-fill').forEach((bar, i) => {
      const w = bar.style.width;
      bar.style.width = '0%';
      setTimeout(() => { bar.style.width = w; }, 100 + i * 50);
    });
  }, 100);
}

function showError(message, hintApi = false) {
  document.getElementById('dashboard-content').innerHTML = `
    <div class="error">
      <h3>Error</h3>
      <p>${message}</p>
      ${hintApi ? `<p>Tip: open <code>/api/survey-data</code> in a new tab to verify the JSON.</p>` : ''}
    </div>
  `;
}

(async function init() {
  try {
    const payload = await fetchSurvey();
    if (!payload?.success || !Array.isArray(payload.questions) || !payload.questions.length) {
      showError(payload?.message || 'Unknown error.', true);
      return;
    }
    renderDashboard(payload);
  } catch (err) {
    showError(`API error: ${err.message || err}`, true);
  }
})();
</script>
</body>
</html>
